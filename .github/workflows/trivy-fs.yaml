name: Trivy FS Scan

on:
  workflow_call:
    inputs:
      scan-path:
        description: "Path to scan (default: current directory)"
        required: false
        default: "."
        type: string

jobs:
  trivy-fs-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:

      # 1️⃣ Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2️⃣ Cache Trivy DB for speed
      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ runner.os }}
          restore-keys: trivy-db-${{ runner.os }}

      # 3️⃣ Run Trivy filesystem scan (JSON only)
      - name: Run Trivy FS Scan (JSON)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: ${{ inputs.scan-path }}
          format: json
          output: trivy-fs-report.json

      # 4️⃣ Upload JSON report as artifact
      - name: Upload JSON report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-fs-report-json
          path: trivy-fs-report.json
